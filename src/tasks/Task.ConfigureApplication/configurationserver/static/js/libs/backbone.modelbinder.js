/*
Backbone.ModelBinder v0.1.6 "2012-10-05T19:41" "commit ID 2e2c28651b96c8150119486bc4872a4a211257f6"
(c) 2012 Bart Wood
Distributed Under MIT License
*/
(function(f){f(_,$,Backbone)})(function(f,h,e){if(!e)throw"Please include Backbone.js before Backbone.ModelBinder.js";e.ModelBinder=function(a){f.bindAll(this);this._modelSetOptions=a||{}};e.ModelBinder.VERSION="0.1.6";e.ModelBinder.Constants={};e.ModelBinder.Constants.ModelToView="ModelToView";e.ModelBinder.Constants.ViewToModel="ViewToModel";f.extend(e.ModelBinder.prototype,{bind:function(a,b,c,d){this.unbind();this._model=a;this._rootEl=b;this._modelSetOptions=f.extend({},this._modelSetOptions,
d);if(!this._model)throw"model must be specified";if(!this._rootEl)throw"rootEl must be specified";c?(this._attributeBindings=h.extend(!0,{},c),this._initializeAttributeBindings(),this._initializeElBindings()):this._initializeDefaultBindings();this._bindModelToView();this._bindViewToModel()},bindCustomTriggers:function(a,b,c,d,g){this._triggers=c;this.bind(a,b,d,g)},unbind:function(){this._unbindModelToView();this._unbindViewToModel();this._attributeBindings&&(delete this._attributeBindings,this._attributeBindings=
void 0)},_initializeAttributeBindings:function(){var a,b,c,d;for(a in this._attributeBindings){b=this._attributeBindings[a];if(f.isString(b))c={elementBindings:[{selector:b}]};else if(f.isArray(b))c={elementBindings:b};else if(f.isObject(b))c={elementBindings:[b]};else throw"Unsupported type passed to Model Binder "+c;for(b=0;b<c.elementBindings.length;b++)d=c.elementBindings[b],d.attributeBinding=c;c.attributeName=a;this._attributeBindings[a]=c}},_initializeDefaultBindings:function(){var a,b,c,d,
g;this._attributeBindings={};b=h("[name]",this._rootEl);for(a=0;a<b.length;a++)c=b[a],d=h(c).attr("name"),this._attributeBindings[d]?this._attributeBindings[d].elementBindings.push({attributeBinding:this._attributeBindings[d],boundEls:[c]}):(g={attributeName:d},g.elementBindings=[{attributeBinding:g,boundEls:[c]}],this._attributeBindings[d]=g)},_initializeElBindings:function(){var a,b,c,d,g,i,e;for(a in this._attributeBindings){b=this._attributeBindings[a];for(c=0;c<b.elementBindings.length;c++){d=
b.elementBindings[c];g=""===d.selector?h(this._rootEl):h(d.selector,this._rootEl);if(0===g.length)throw"Bad binding found. No elements returned for binding selector "+d.selector;d.boundEls=[];for(i=0;i<g.length;i++)e=g[i],d.boundEls.push(e)}}},_bindModelToView:function(){this._model.on("change",this._onModelChange,this);this.copyModelAttributesToView()},copyModelAttributesToView:function(a){var b,c;for(b in this._attributeBindings)if(void 0===a||-1!==f.indexOf(a,b))c=this._attributeBindings[b],this._copyModelToView(c)},
_unbindModelToView:function(){this._model&&(this._model.off("change",this._onModelChange),this._model=void 0)},_bindViewToModel:function(){this._triggers?f.each(this._triggers,function(a,b){h(this._rootEl).delegate(b,a,this._onElChanged)},this):(h(this._rootEl).delegate("","change",this._onElChanged),h(this._rootEl).delegate("[contenteditable]","blur",this._onElChanged))},_unbindViewToModel:function(){this._rootEl&&(this._triggers?f.each(this._triggers,function(a,b){h(this._rootEl).undelegate(b,a,
this._onElChanged)},this):(h(this._rootEl).undelegate("","change",this._onElChanged),h(this._rootEl).undelegate("[contenteditable]","blur",this._onElChanged)))},_onElChanged:function(a){var b,c,d,a=h(a.target)[0];b=this._getElBindings(a);for(c=0;c<b.length;c++)d=b[c],this._isBindingUserEditable(d)&&this._copyViewToModel(d,a)},_isBindingUserEditable:function(a){return void 0===a.elAttribute||"text"===a.elAttribute||"html"===a.elAttribute},_getElBindings:function(a){var b,c,d,g,i,e,h=[];for(b in this._attributeBindings){c=
this._attributeBindings[b];for(d=0;d<c.elementBindings.length;d++){g=c.elementBindings[d];for(i=0;i<g.boundEls.length;i++)e=g.boundEls[i],e===a&&h.push(g)}}return h},_onModelChange:function(){var a,b;for(a in this._model.changedAttributes())(b=this._attributeBindings[a])&&this._copyModelToView(b)},_copyModelToView:function(a){var b,c,d,g,i,f;i=this._model.get(a.attributeName);for(b=0;b<a.elementBindings.length;b++){c=a.elementBindings[b];for(d=0;d<c.boundEls.length;d++)g=c.boundEls[d],g._isSetting||
(f=this._getConvertedValue(e.ModelBinder.Constants.ModelToView,c,i),this._setEl(h(g),c,f))}},_setEl:function(a,b,c){b.elAttribute?this._setElAttribute(a,b,c):this._setElValue(a,c)},_setElAttribute:function(a,b,c){switch(b.elAttribute){case "html":a.html(c);break;case "text":a.text(c);break;case "enabled":a.attr("disabled",!c);break;case "displayed":a[c?"show":"hide"]();break;case "hidden":a[c?"hide":"show"]();break;case "css":a.css(b.cssAttribute,c);break;case "class":var d=this._model.previous(b.attributeBinding.attributeName);
f.isUndefined(d)||(d=this._getConvertedValue(e.ModelBinder.Constants.ModelToView,b,d),a.removeClass(d));c&&a.addClass(c);break;default:a.attr(b.elAttribute,c)}},_setElValue:function(a,b){if(a.attr("type"))switch(a.attr("type")){case "radio":a.val()===b&&a.attr("checked","checked");break;case "checkbox":b?a.attr("checked","checked"):a.removeAttr("checked");break;default:a.val(b)}else a.is("input")||a.is("select")||a.is("textarea")?a.val(b):a.text(b)},_copyViewToModel:function(a,b){var c;b._isSetting||
(b._isSetting=!0,this._setModel(a,h(b)),b._isSetting=!1,a.converter&&(c=this._model.get(a.attributeBinding.attributeName),c=this._getConvertedValue(e.ModelBinder.Constants.ModelToView,a,c),this._setEl(h(b),a,c)))},_getElValue:function(a,b){switch(b.attr("type")){case "checkbox":return b.prop("checked")?!0:!1;default:return void 0!==b.attr("contenteditable")?b.html():b.val()}},_setModel:function(a,b){var c={},d=this._getElValue(a,b),d=this._getConvertedValue(e.ModelBinder.Constants.ViewToModel,a,d);
c[a.attributeBinding.attributeName]=d;d=f.extend({},this._modelSetOptions,{changeSource:"ModelBinder"});this._model.set(c,d)},_getConvertedValue:function(a,b,c){b.converter&&(c=b.converter(a,c,b.attributeBinding.attributeName,this._model));return c}});e.ModelBinder.CollectionConverter=function(a){this._collection=a;if(!this._collection)throw"Collection must be defined";f.bindAll(this,"convert")};f.extend(e.ModelBinder.CollectionConverter.prototype,{convert:function(a,b){return a===e.ModelBinder.Constants.ModelToView?
b?b.id:void 0:this._collection.get(b)}});e.ModelBinder.createDefaultBindings=function(a,b,c,d){var g,e,f={},a=h("["+b+"]",a);for(g=0;g<a.length;g++)e=a[g],e=h(e).attr(b),f[e]||(f[e]={selector:"["+b+'="'+e+'"]'},c&&(f[e].converter=c),d&&(f[e].elAttribute=d));return f};e.ModelBinder.combineBindings=function(a,b){f.each(b,function(b,d){var e={selector:b.selector};b.converter&&(e.converter=b.converter);b.elAttribute&&(e.elAttribute=b.elAttribute);a[d]=a[d]?[a[d],e]:e});return a};return e.ModelBinder});